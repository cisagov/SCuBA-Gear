# Purpose: Run unit tests for the code used in workflows

name: Unit Test Workflow

# This is a reusable workflow called by the pipeline.
on:
  workflow_call:
  workflow_dispatch:

permissions: read-all

jobs:
  workflow-tests:
    name: Workflow Unit Tests
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Run Pester Tests
        run: |
          # This should run all workflow unit tests
          Import-Module -Name Pester -Version 5.5.0
          $config = [PesterConfiguration] @{
            Run    = @{ Path = 'Testing/workflow' }
            Should = @{ ErrorAction = 'Continue' }
            Output = @{ Verbosity = 'Detailed' }
          }
          $result = Try {
            # Invoke-Pester -Output 'Detailed' -Path 'Testing/workflow/fakedirectory'
            # Invoke-Pester -Output 'Detailed' -Path 'Testing/workflow'
            Invoke-Pester -Configuration $config 6>&1
          } Catch {
            Write-Warning "This is the catch"
            Write-Warning $_
            exit 1
          }
          if ($result -eq $null) {
            throw "Pester failed to run."
          }
          Write-Warning $result
