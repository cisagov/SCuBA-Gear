# Author: James Garriss
# Purpose: Run the product functional tests every night

name: Nightly Product Functional Tests

# Run this workflow at midnight 
# on every Sun to Thr (b/c GMT -5)
on:
  schedule:
  - cron: '0 4 * * 0-4'
  workflow_dispatch: 
  push:

jobs:
  sharepoint-test:
    name: SharePoint Test
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell 
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4
    - name: Create PFX
      run: |
        New-Item -ItemType file -Path ./key.txt
        Set-Content -Path ./key.txt -Value $env:PfxBase64
        certutil -decode ./key.txt ./key.pfx
      env:
        PfxBase64: ${{ secrets.NIGHTLY_TEST_BUILD_PFX }}
    - name: Import PFX
      run: Import-PfxCertificate -Password (ConvertTo-SecureString -String $env:PfxPassword -AsPlainText -Force) -CertStoreLocation Cert:\CurrentUser\My -FilePath ./key.pfx
      env:
        PfxPassword: ${{ secrets.NIGHTLY_TEST_BUILD_PW }}
    # - name: Get Thumbprint
    #   id: thumbprint
    #   run: |
    #     $thumbprint = Get-PfxCertificate -FilePath ./key.pfx -Password (ConvertTo-SecureString -String $env:PfxPassword -AsPlainText -Force)
    #     Write-Output "THUMBPRINT_VALUE=$thumbprint" >> $GITHUB_OUTPUT
    #     echo "THUMBPRINT_VALUE2=$thumbprint" >> $GITHUB_OUTPUT
    #   shell: pwsh
    #   env:
    #     PfxPassword: ${{ secrets.NIGHTLY_TEST_BUILD_PW }}
    - name: Setup for Scuba
      run: ./SetUp.ps1
    - name: Install Selenium
      run: Install-Module -Name Selenium
    - name: Update Selenium
      run: ./Testing/Functional/SmokeTest/UpdateSelenium.ps1
    - name: Test SharePoint
      run: |
        $thumbprint = Get-PfxCertificate -FilePath ./key.pfx -Password (ConvertTo-SecureString -String $env:PfxPassword -AsPlainText -Force)
        Write-Debug "The thumbprint is "
        Write-Output $thumbprint
        ./Testing/Functional/Products/Tests/CallProductTests.ps1
      shell: pwsh
      env:
        PfxPassword: ${{ secrets.NIGHTLY_TEST_BUILD_PW }}
