on: 
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/run_publish_package.yaml"

name: Publish Package

env:
  GalleryName: PrivateScubaGearGallery
  ModuleName: ScubaGear

jobs:
  Publish-Private-Package:
    runs-on: windows-latest
    defaults:
      run:
        shell: powershell
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: src  
      - name: Publish ScubaGear module to private repository
        run: |
          cd src
          $sha = $(git rev-parse --short HEAD)
          $sha
          . utils/DeployUtils.ps1 
          $DebugPreference = "Continue" 
          New-PrivateGallery -GalleryName $env:GalleryName -Trusted

          Publish-ScubaGearModule -Path PowerShell/ScubaGear -Repository $env:GalleryName -ModuleVersion '1.0.0'
      - name: Test Module Publish
        run: |
          Invoke-Pester src/Testing/Functional/BuildTest/ModuleBuildTests.ps1 
  # Call-Smoke-Test:
  #   needs: Publish-Private-Package
  #   uses: ./.github/workflows/run_smoke_test.yaml

