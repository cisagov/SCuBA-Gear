ProductName: sharepoint
Description: This test plan is for use with a Service Principal.  It will use PnP module as primary provided setting export tool.
TestPlan:
  - PolicyId: MS.SHAREPOINT.1.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.SHAREPOINT.1.1v1 Non-compliant - ExternalUserAndGuestSharing (3)
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserAndGuestSharing
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.1.1v1 Non-compliant - ExternalUserSharingOnly (1)
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserSharingOnly
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.1.1v1 Compliant - ExistingExternalUserSharingOnly (2)
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExistingExternalUserSharingOnly
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.SHAREPOINT.1.1v1 Compliant - Disabled (0)
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: Disabled
        Postconditions: []
        ExpectedResult: true

  - PolicyId: MS.SHAREPOINT.1.2v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.SHAREPOINT.1.2v1 Not Checked (PnP)
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false

  - PolicyId: MS.SHAREPOINT.1.3v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.SHAREPOINT.1.3v1 Non-compliant - SharingCapability = ExternalUserSharingOnly (New and existing guests); SharingDomainRestrictionMode = BlockList
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserSharingOnly
              SharingDomainRestrictionMode: BlockList
              SharingBlockedDomainList: nefarious.com evil.is.us
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.1.3v1 Compliant -  SharingCapability = ExternalUserSharingOnly (New and existing guests); SharingDomainRestrictionMode = AllowList
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserSharingOnly
              SharingDomainRestrictionMode: AllowList
              SharingAllowedDomainList: good.org admirable.us
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.SHAREPOINT.1.3v1 Compliant -  SharingCapability = ExternalUserAndGuestSharing (Anyone); SharingDomainRestrictionMode = AllowList
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserAndGuestSharing
              SharingDomainRestrictionMode: AllowList
              SharingAllowedDomainList: good.org admirable.us
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.SHAREPOINT.1.3v1 Non-Applicable - SharingCapability = Disabled (Only people in organization);
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: Disabled
              SharingDomainRestrictionMode: None
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.1.3v1 Non-Applicable - SharingCapability = Disabled (Only people in organization); SharingDomainRestrictionMode = AllowList
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: Disabled
              SharingDomainRestrictionMode: AllowList
              SharingAllowedDomainList: good.org admirable.us
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false

  - PolicyId: MS.SHAREPOINT.1.4v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.SHAREPOINT.1.4v1 Non-compliant - SharingCapability = ExternalUserSharingOnly (New and existing guests); RequireAcceptingAccountMatchInvitedAccount = false
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserSharingOnly
              RequireAcceptingAccountMatchInvitedAccount: false
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.1.4v1 Compliant - SharingCapability = ExternalUserAndGuestSharing (Anyone); RequireAcceptingAccountMatchInvitedAccount = true
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserAndGuestSharing
              RequireAcceptingAccountMatchInvitedAccount: true
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.SHAREPOINT.1.4v1 Compliant - SharingCapability = ExistingExternalUserSharingOnly (Existing guests); RequireAcceptingAccountMatchInvitedAccount = true
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExistingExternalUserSharingOnly
              RequireAcceptingAccountMatchInvitedAccount: true
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.SHAREPOINT.1.4v1 Compliant - SharingCapability = ExternalUserSharingOnly (New and existing guests); RequireAcceptingAccountMatchInvitedAccount = true
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserSharingOnly
              RequireAcceptingAccountMatchInvitedAccount: true
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.SHAREPOINT.1.4v1 Non-Applicable - SharingCapability = Disabled (Only people in organization); RequireAcceptingAccountMatchInvitedAccount = true
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: Disabled
              RequireAcceptingAccountMatchInvitedAccount: true
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.1.4v1 Non-Applicable - SharingCapability = Disabled (Only people in organization); RequireAcceptingAccountMatchInvitedAccount = false
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: Disabled
              RequireAcceptingAccountMatchInvitedAccount: false
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false

  - PolicyId: MS.SHAREPOINT.2.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.SHAREPOINT.2.1v1 Non-compliant - DefaultSharingLinkType = None
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              DefaultSharingLinkType: None
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.2.1v1 Non-compliant - DefaultSharingLinkType = Internal
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              DefaultSharingLinkType: Internal
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.2.1v1 Non-compliant - DefaultSharingLinkType = AnonymousAccess
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserAndGuestSharing
              DefaultSharingLinkType: AnonymousAccess
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.2.1v1 Compliant - DefaultSharingLinkType = Direct
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: Disabled
              DefaultSharingLinkType: Direct
        Postconditions: []
        ExpectedResult: true

  - PolicyId: MS.SHAREPOINT.2.2v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.SHAREPOINT.2.2v1 Non-compliant - DefaultLinkPermission = Edit
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              DefaultLinkPermission: Edit
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.2.2v1 Compliant - DefaultLinkPermission = View
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              DefaultLinkPermission: View
        Postconditions: []
        ExpectedResult: true

  - PolicyId: MS.SHAREPOINT.3.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.SHAREPOINT.3.1v1 Non-compliant - SharingCapability = ExternalUserAndGuestSharing; RequireAnonymousLinksExpireInDays > 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              RequireAnonymousLinksExpireInDays: 31
              SharingCapability: ExternalUserAndGuestSharing
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.3.1v1 Compliant - SharingCapability = ExternalUserAndGuestSharing (Anyone); RequireAnonymousLinksExpireInDays < 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              RequireAnonymousLinksExpireInDays: 7
              SharingCapability: ExternalUserAndGuestSharing
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.SHAREPOINT.3.1v1 Compliant - SharingCapability = ExternalUserAndGuestSharing (Anyone); RequireAnonymousLinksExpireInDays = 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              RequireAnonymousLinksExpireInDays: 30
              SharingCapability: ExternalUserAndGuestSharing
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.SHAREPOINT.3.1v1 Non-Compliant - SharingCapability = ExternalUserSharingOnly (New and existing guests); RequireAnonymousLinksExpireInDays = 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              RequireAnonymousLinksExpireInDays: 30
              SharingCapability: ExternalUserSharingOnly
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.3.1v1 Non-Compliant - SharingCapability = ExistingExternalUserSharingOnly (Existing guests); RequireAnonymousLinksExpireInDays = 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              RequireAnonymousLinksExpireInDays: 30
              SharingCapability: ExistingExternalUserSharingOnly
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.3.1v1 Non-Compliant - SharingCapability = Disabled (Only people in your organization); RequireAnonymousLinksExpireInDays = 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              RequireAnonymousLinksExpireInDays: 30
              SharingCapability: Disabled
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.3.1v1 Non-Applicable - SharingCapability = ExternalUserSharingOnly (New and existing guests); RequireAnonymousLinksExpireInDays = 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              RequireAnonymousLinksExpireInDays: 30
              SharingCapability: ExternalUserSharingOnly
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.3.1v1 Non-Applicable - SharingCapability = ExistingExternalUserSharingOnly (Existing guests); RequireAnonymousLinksExpireInDays = 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              RequireAnonymousLinksExpireInDays: 30
              SharingCapability: ExistingExternalUserSharingOnly
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.3.1v1 Non-Applicable - SharingCapability = Disabled (Only people in your organization); RequireAnonymousLinksExpireInDays = 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              RequireAnonymousLinksExpireInDays: 30
              SharingCapability: Disabled
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false

  - PolicyId: MS.SHAREPOINT.3.2v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.SHAREPOINT.3.2v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false

  - PolicyId: MS.SHAREPOINT.3.3v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.SHAREPOINT.3.3v1 Non-Applicable - SharingCapability = ExistingExternalUserSharingOnly (Existing guests); EmailAttestationRequired = false; EmailAttestationReAuthDays = 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExistingExternalUserSharingOnly
              EmailAttestationRequired: false
              EmailAttestationReAuthDays: 30
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.3.3v1 Non-compliant - SharingCapability = ExternalUserSharingOnly (New and existing guests); EmailAttestationRequired = false; EmailAttestationReAuthDays = 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserSharingOnly
              EmailAttestationRequired: false
              EmailAttestationReAuthDays: 30
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.3.3v1 Non-compliant - SharingCapability = ExternalUserAndGuestSharing (Anyone); EmailAttestationRequired = false; EmailAttestationReAuthDays = 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserAndGuestSharing
              EmailAttestationRequired: false
              EmailAttestationReAuthDays: 30
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.3.3v1 Non-Applicable - SharingCapability = ExistingExternalUserSharingOnly (Existing guests); EmailAttestationRequired = true; EmailAttestationReAuthDays > 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExistingExternalUserSharingOnly
              EmailAttestationRequired: true
              EmailAttestationReAuthDays: 31
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.3.3v1 Non-compliant - SharingCapability = ExternalUserSharingOnly (New and existing guests); EmailAttestationRequired = true; EmailAttestationReAuthDays > 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserSharingOnly
              EmailAttestationRequired: true
              EmailAttestationReAuthDays: 31
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.3.3v1 Non-compliant - SharingCapability = ExternalUserAndGuestSharing (Anyone); EmailAttestationRequired = true; EmailAttestationReAuthDays > 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserAndGuestSharing
              EmailAttestationRequired: true
              EmailAttestationReAuthDays: 31
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.3.3v1 Non-Applicable - SharingCapability = ExistingExternalUserSharingOnly (Existing guests); EmailAttestationRequired = true; EmailAttestationReAuthDays = 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExistingExternalUserSharingOnly
              EmailAttestationRequired: true
              EmailAttestationReAuthDays: 30
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.3.3v1 Compliant - SharingCapability = ExternalUserSharingOnly (New and existing guests); EmailAttestationRequired = true; EmailAttestationReAuthDays = 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserSharingOnly
              EmailAttestationRequired: true
              EmailAttestationReAuthDays: 30
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.SHAREPOINT.3.3v1 Compliant - SharingCapability = ExternalUserAndGuestSharing (Anyone); EmailAttestationRequired = true; EmailAttestationReAuthDays = 30
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: ExternalUserAndGuestSharing
              EmailAttestationRequired: true
              EmailAttestationReAuthDays: 30
        Postconditions: []
        ExpectedResult: true
      - TestDescription: MS.SHAREPOINT.3.3v1 Non-Applicable - SharingCapability = Disabled (Only people in organization)
        Preconditions:
          - Command: Set-PnPTenant
            Splat:
              SharingCapability: Disabled
              EmailAttestationRequired: true
              EmailAttestationReAuthDays: 29
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false

  - PolicyId: MS.SHAREPOINT.4.1v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.AAD.4.1v1 Not Checked
        Preconditions: []
        Postconditions: []
        IsNotChecked: true
        ExpectedResult: false

  - PolicyId: MS.SHAREPOINT.4.2v1
    TestDriver: RunScuba
    Tests:
      - TestDescription: MS.SHAREPOINT.4.2v1 Non-compliant DenyAddAndCustomizePages disabled
        Preconditions:
          - Command: "Set-PnPTenantSite -Identity $((Get-PnPTenantInstance).PortalUrl) -DenyAddAndCustomizePages:$false"
        Postconditions: []
        ExpectedResult: false
      - TestDescription: MS.SHAREPOINT.4.2v1 Compliant DenyAddAndCustomizePages enabled
        Preconditions:
          - Command: "Set-PnPTenantSite -Identity $((Get-PnPTenantInstance).PortalUrl) -DenyAddAndCustomizePages"
        Postconditions: []
        ExpectedResult: true
